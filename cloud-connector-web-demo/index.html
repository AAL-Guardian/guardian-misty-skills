<html>
  <head>
    <script
      type="application/javascript"
      src="/node_modules/mqtt/dist/mqtt.min.js"
    ></script>
    <!-- <script type="application/javascript" src="/node_modules/bent/src/core.js"></script>
    <script type="module" src="/node_modules/bent/src/browser.js"></script> -->
  </head>
  <body>
    look at console
  </body>
  <script>
    (async () => {
      const response = await fetch(
        "https://pou41w0mic.execute-api.eu-west-1.amazonaws.com/dev/senior/install",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ robotCode: "tesasd1343423" }),
        }
      );
      const data = await response.json();

      const client = await mqtt.connect({
        protocol: "wss",
        path: "/mqtt?x-amz-customauthorizer-name=GuardianAuthorizer",
        hostname: data.endpoint,
        clientId: data.clientId,
        reconnectPeriod: 30 * 1000,
        username: data.token,
        // transformWsUrl(url, options) {
        //   options.username = data.token;
        //   return url;
        // },
      });

      client.on("connect", (connack) => {
        console.log("connect", connack);
        client.subscribe("test", (err) => {
          if (!err) {
            client.publish("test", "Hello mqtt");
          }
        });
      });

      client.on("reconnect", () => {
        console.log("reconnect");
      });
      client.on("disconnect", () => {
        console.log("disconnect");
      });
      client.on("disconnect", () => {
        console.log("disconnect");
      });
      client.on("error", (err) => {
        console.log("error", err);
      });

      client.on("message", function (topic, message) {
        // message is Buffer
        console.log(message.toString());
        client.end();
      });
    })();
  </script>
</html>
